# Alembic æ•°æ®åº“è¿ç§»æŒ‡å—

æœ¬é¡¹ç›®æ”¯æŒ **PostgreSQL** å’Œ **SQLite** ä¸¤ç§æ•°æ®åº“ï¼Œä½¿ç”¨ç‹¬ç«‹çš„ Alembic é…ç½®ç®¡ç†è¿ç§»ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ alembic-postgres.ini       # PostgreSQL é…ç½®æ–‡ä»¶
â”œâ”€â”€ alembic-sqlite.ini         # SQLite é…ç½®æ–‡ä»¶
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ postgres/              # PostgreSQL è¿ç§»è„šæœ¬ç›®å½•
â”‚   â”‚   â”œâ”€â”€ env.py
â”‚   â”‚   â”œâ”€â”€ script.py.mako
â”‚   â”‚   â””â”€â”€ versions/          # PostgreSQL è¿ç§»ç‰ˆæœ¬
â”‚   â”‚       â”œâ”€â”€ 20251226_1008_ee0a189f1532_åˆå§‹æ•°æ®åº“ç»“æ„.py
â”‚   â”‚       â””â”€â”€ 20251226_1102_e411428f00c0_åˆå§‹åŒ–é¢„ç½®æ•°æ®.py
â”‚   â””â”€â”€ sqlite/                # SQLite è¿ç§»è„šæœ¬ç›®å½•
â”‚       â”œâ”€â”€ env.py
â”‚       â”œâ”€â”€ script.py.mako
â”‚       â””â”€â”€ versions/          # SQLite è¿ç§»ç‰ˆæœ¬
â”‚           â””â”€â”€ 20251226_1322_fbeb1038c728_åˆå§‹åŒ–sqliteæ•°æ®åº“.py
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. PostgreSQL æ•°æ®åº“

#### é…ç½®ç¯å¢ƒå˜é‡
```bash
# .env æ–‡ä»¶
DATABASE_URL=postgresql+asyncpg://username:password@localhost:5432/database_name
```

#### ç”Ÿæˆè¿ç§»è„šæœ¬
```bash
cd backend
alembic -c alembic-postgres.ini revision --autogenerate -m "æè¿°ä¿¡æ¯"
```

#### åº”ç”¨è¿ç§»
```bash
alembic -c alembic-postgres.ini upgrade head
```

#### å›é€€è¿ç§»
```bash
alembic -c alembic-postgres.ini downgrade -1
```

#### æŸ¥çœ‹è¿ç§»å†å²
```bash
alembic -c alembic-postgres.ini history
alembic -c alembic-postgres.ini current
```

### 2. SQLite æ•°æ®åº“

#### é…ç½®ç¯å¢ƒå˜é‡
```bash
# .env æ–‡ä»¶
DATABASE_URL=sqlite+aiosqlite:///./data/mumuai.db
```

#### ç”Ÿæˆè¿ç§»è„šæœ¬
```bash
cd backend
alembic -c alembic-sqlite.ini revision --autogenerate -m "æè¿°ä¿¡æ¯"
```

#### åº”ç”¨è¿ç§»
```bash
alembic -c alembic-sqlite.ini upgrade head
```

#### å›é€€è¿ç§»
```bash
alembic -c alembic-sqlite.ini downgrade -1
```

#### æŸ¥çœ‹è¿ç§»å†å²
```bash
alembic -c alembic-sqlite.ini history
alembic -c alembic-sqlite.ini current
```

## âš™ï¸ å…³é”®é…ç½®å·®å¼‚

### PostgreSQL (alembic/postgres/env.py)
- `render_as_batch=False` - ç›´æ¥æ”¯æŒ ALTER TABLE
- ä½¿ç”¨ `server_default=sa.text('now()')` 

### SQLite (alembic/sqlite/env.py)
- `render_as_batch=True` - é€šè¿‡é‡å»ºè¡¨å®ç° ALTER TABLE
- ä½¿ç”¨ `server_default=sa.text('(CURRENT_TIMESTAMP)')` - SQLite æ ¼å¼

## ğŸ“ æ³¨æ„äº‹é¡¹

### SQLite é™åˆ¶
1. **å¹¶å‘å†™å…¥**ï¼šåŒæ—¶åªå…è®¸ä¸€ä¸ªå†™æ“ä½œ
2. **ALTER TABLE é™åˆ¶**ï¼šæŸäº›æ“ä½œéœ€è¦é‡å»ºè¡¨ï¼ˆAlembic çš„æ‰¹å¤„ç†æ¨¡å¼ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
3. **ç±»å‹æ˜ å°„**ï¼š
   - `JSON` â†’ `TEXT` (SQLAlchemy è‡ªåŠ¨å¤„ç†)
   - `BOOLEAN` â†’ `INTEGER` (0/1)
   - `DEFAULT now()` â†’ `DEFAULT CURRENT_TIMESTAMP`

### PostgreSQL ä¼˜åŠ¿
1. **é«˜å¹¶å‘æ”¯æŒ**ï¼šå¤šç”¨æˆ·åŒæ—¶è¯»å†™
2. **å®Œæ•´çš„ ALTER TABLE æ”¯æŒ**
3. **é«˜çº§ç‰¹æ€§**ï¼šå…¨æ–‡æœç´¢ã€JSON æ“ä½œç¬¦ã€æ•°ç»„ç±»å‹ç­‰

## ğŸ”„ åˆ‡æ¢æ•°æ®åº“

åªéœ€ä¿®æ”¹ `.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL`ï¼Œç„¶åä½¿ç”¨å¯¹åº”çš„é…ç½®æ–‡ä»¶æ‰§è¡Œè¿ç§»ï¼š

```bash
# åˆ‡æ¢åˆ° SQLite
DATABASE_URL=sqlite+aiosqlite:///./data/mumuai.db
alembic -c alembic-sqlite.ini upgrade head

# åˆ‡æ¢åˆ° PostgreSQL
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/db
alembic -c alembic-postgres.ini upgrade head
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ SQLiteï¼ˆç®€å•ã€æ— éœ€é¢å¤–æœåŠ¡ï¼‰
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ PostgreSQLï¼ˆæ€§èƒ½ã€å¹¶å‘ã€ç¨³å®šæ€§ï¼‰
3. **ä¿æŒåŒæ­¥**ï¼šä¸¤ä¸ªæ•°æ®åº“çš„æ¨¡å‹å®šä¹‰å¿…é¡»ä¸€è‡´
4. **æµ‹è¯•è¿ç§»**ï¼šåœ¨ä¸¤ç§æ•°æ®åº“ä¸Šéƒ½æµ‹è¯•è¿ç§»è„šæœ¬

## ğŸ› å¸¸è§é—®é¢˜

### Q: è¿ç§»è„šæœ¬ç”Ÿæˆåå¯ä»¥é€šç”¨å—ï¼Ÿ
A: ä¸è¡Œã€‚PostgreSQL å’Œ SQLite çš„è¿ç§»è„šæœ¬æ˜¯ç‹¬ç«‹çš„ï¼Œå› ä¸ºï¼š
- SQL è¯­æ³•å·®å¼‚ï¼ˆå¦‚ DEFAULT å€¼ï¼‰
- ç±»å‹å·®å¼‚ï¼ˆå¦‚ JSONã€BOOLEANï¼‰
- ALTER TABLE èƒ½åŠ›å·®å¼‚

### Q: å¦‚ä½•ä» PostgreSQL è¿ç§»æ•°æ®åˆ° SQLiteï¼Ÿ
A: éœ€è¦ç¼–å†™æ•°æ®å¯¼å‡º/å¯¼å…¥è„šæœ¬ï¼Œä¸èƒ½ç›´æ¥å¤ç”¨è¿ç§»è„šæœ¬ã€‚

### Q: ä¸ºä»€ä¹ˆ SQLite è¿ç§»è¿™ä¹ˆæ…¢ï¼Ÿ
A: SQLite çš„ ALTER TABLE é™åˆ¶å¯¼è‡´éœ€è¦é‡å»ºè¡¨ï¼Œè¿™åœ¨å¤§è¡¨æ—¶ä¼šå¾ˆæ…¢ã€‚